# A Capacitated Vehicle Routing Problem solver

import numpy as np
import random
from typing import List, Dict, Any
from ortools.constraint_solver import routing_enums_pb2, pywrapcp
from ortools.constraint_solver.pywrapcp import RoutingIndexManager, RoutingModel, Assignment


class FacilityOrderSolver:
    def __init__(self, full_distance_matrix: List[List[float]], home_index: int, num_vehicles: int):
        """Create a new solver object based on the supplied route information.

        Parameters
        ----------
        full_distance_matrix : List[List[float]]
            A 2D square matrix representing the distance between all facilities.
            The data is expected to be mirrored over the
            main diagonal (which itself is expected to be 0s).
            The number of facilities is implied to be the length of the matrix.
        home_index : int
            The index of the facility designated as the "home" or origin point.
        """
        # matrix needs to be ints, so scale up before converting
        self.matrix = (np.array(full_distance_matrix)*100).astype(np.int32)
        self.home_index = home_index
        self.num_vehicles = num_vehicles

    def _create_data_model(self, indices_to_visit: List[int] = None) -> Dict[str, Any]:
        """Stores the data for the problem

        Parameters
        ----------
        indices_to_visit : List[int]
            The list of indices corresponding to the desired facilities to visit.

        Note
        ----
        In this context, the index of the home facility is made relative to the list
        of facilities to visit (as opposed to the list of all facilties).
        This is needed to comply with how the solver works based on the example by Google.

        Returns
        -------
        Dict[str, Any]
            With keys:
            - 'distance_matrix', set to original or rearranged distance matrix
            - 'num_vehicles', set to the number of vehicles available
            - 'home', set to the relative index of the home facility

        """
        # slice the master matrix so that only the desired indices are included
        # (or don't slice if all are desired)
        if indices_to_visit is None:
            relative_home_index = self.home_index
            matrix = self.matrix
        else:
            relative_home_index = indices_to_visit.index(self.home_index)
            #matrix = np.rot90(np.rot90(self.matrix[ indices_to_visit ], k=-1)[ indices_to_visit ], k=1)
            matrix = self.matrix
            print("reduced matrix: ", matrix)
        
        vehicle_cap = []
        for i in range(self.num_vehicles):
            vehicle_cap.append(3)

        data = {'distance_matrix': matrix,
            'num_vehicles': self.num_vehicles,
            'home': relative_home_index,
            'vehicle_capacities': vehicle_cap,
            'demands': [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}
        return data

    def _extract_solution(self, manager: RoutingIndexManager, routing: RoutingModel, assignment: Assignment, indices_to_visit: List[int]) -> Dict[str, Any]:
        """Transform results to a usable format

        Parameters
        ----------
        manager : RoutingIndexManager
            OR-tools' object to manage conversion between NodeIndex and variable index
        routing : RoutingModel
            OR-tools' object for route solving
        assignment : Assignment
            OR-tools' object for mapping from variable to domains
        indices_to_visit : List[int]
            The list of indices corresponding to the desired facilities to visit        

        Returns
        -------
        Dict[str, Any]
            With keys:
            - 'objective', set to objective value (minified distance)
            - 'order', instructions for the order of facilities to visit

        """

        data = self._create_data_model(indices_to_visit)
        two_dim_matrix = []
        sln = {"objective": assignment.ObjectiveValue()}
        for vehicle_id in range(data['num_vehicles']):
            stop_indices = []
            index = routing.Start(vehicle_id)
            while not routing.IsEnd(index):
                relative_index= manager.IndexToNode(index)
                stop_indices.append(indices_to_visit[relative_index])
                previous_index = index
                index = assignment.Value(routing.NextVar(index))
            relative_index = manager.IndexToNode(index)
            stop_indices.append(indices_to_visit[relative_index])
            two_dim_matrix.append(stop_indices)
            
        temp_arr = []
        for k in range(data['num_vehicles']):
            if (set(two_dim_matrix[k]) == set([0,0])):
                continue
            else:
                temp_arr.append(two_dim_matrix[k])
            
        sln["order"] = temp_arr
        return sln

    def solve(self, indices_to_visit: List[int] = None) -> Dict[str, Any]:
        """Finds the optimal order of facilities to minimize distance.

        Parameters
        ----------
        indices_to_visit : List[int]
            The list of indices corresponding to the desired facilities to visit

        Returns
        -------
        Dict[str, Any]
            Solution dictionary with keys:
            - 'objective', set to objective value (minified distance)
            - 'order', instructions for the order of facilities to visit
        """
        # if no indices are mentioned, we visit all
        if indices_to_visit is None:
            indices_to_visit = list(range(len(self.matrix)))
            
        # make sure home location is in the list if it is not, and that the list is sorted
        if self.home_index not in indices_to_visit:
            indices_to_visit.append(self.home_index)
        indices_to_visit.sort()

        print("calling create data model in solve")
        data = self._create_data_model(indices_to_visit)
        print("finished calling create data model")

        # create routing index manager
        manager = RoutingIndexManager(len(data['distance_matrix']),
                                           data['num_vehicles'], data['home'])

        # create routing model
        routing = RoutingModel(manager)

        def distance_callback(from_index, to_index):
            # returns distance between two nodes
            from_node = manager.IndexToNode(from_index)
            to_node = manager.IndexToNode(to_index)
            dist = data['distance_matrix'][from_node][to_node]

            return dist

        transit_callback_index = routing.RegisterTransitCallback(distance_callback)

        # define cost of each arc
        routing.SetArcCostEvaluatorOfAllVehicles(transit_callback_index)

        # add distance constraints
        dimension_name = 'Distance'
        routing.AddDimension(
            transit_callback_index,
            0,  # no slack
            30000000,  # vehicle maximum travel distance in metres
            True,  # start cumul to zero
            dimension_name)
        distance_dimension = routing.GetDimensionOrDie(dimension_name)
        distance_dimension.SetGlobalSpanCostCoefficient(100000)

        def demand_callback(from_index):
            """Returns the demand of the node."""
            # Convert from routing variable Index to demands NodeIndex.
            from_node = manager.IndexToNode(from_index)
            return data['demands'][from_node]

        demand_callback_index = routing.RegisterUnaryTransitCallback(
            demand_callback)
        routing.AddDimensionWithVehicleCapacity(
            demand_callback_index,
            0,  # null capacity slack
            data['vehicle_capacities'],  # vehicle maximum capacities
            True,  # start cumul to zero
            'Capacity')

        print("finished demand callback")
        # set first solution heuristic
        search_params = pywrapcp.DefaultRoutingSearchParameters()
        search_params.first_solution_strategy = (routing_enums_pb2.FirstSolutionStrategy.PATH_CHEAPEST_ARC)
        search_params.local_search_metaheuristic = (
            routing_enums_pb2.LocalSearchMetaheuristic.GUIDED_LOCAL_SEARCH)
        search_params.time_limit.FromSeconds(1)

        # solve problem
        assignment = routing.SolveWithParameters(search_params)
        print("finished solving ", assignment)
        return self._extract_solution(manager, routing, assignment, indices_to_visit)


def test(indices_to_visit = [13,14,16, 18, 20], num_vehicles=5):
    """ Demonstrates a sample solution. Keep number of indices to be visited <= 2*(num_vehicles) """
 
    home_index = 0 # Depot
    # (values are derived from external resource and multiplied by 1000 for higher accuracy)
    matrix = np.array([[0.  , 1.43, 1.78, 1.91, 1.52, 2.4 , 1.55, 1.28, 1.42, 1.63, 2.59,
        2.3 , 2.33, 2.26, 2.43, 2.47, 2.55, 2.37, 2.57, 2.84, 2.86, 2.93,
        1.93, 2.16, 2.23, 2.37, 2.34, 1.9 , 1.8 , 2.03, 2.27, 1.71, 1.89,
        1.92, 1.83, 1.76, 1.8 , 1.83, 1.81, 1.88, 1.78, 2.33, 2.14, 2.24,
        2.3 , 2.3 , 2.39, 2.41, 2.36, 2.92, 2.86, 2.87, 3.03],
       [1.44, 0.  , 1.16, 0.93, 0.95, 2.01, 0.12, 0.35, 0.84, 0.68, 2.78,
        2.48, 2.51, 2.44, 2.61, 2.65, 2.73, 2.55, 2.08, 2.35, 2.37, 2.44,
        2.11, 1.59, 1.66, 1.8 , 1.77, 1.34, 1.23, 1.46, 1.71, 0.91, 1.08,
        1.14, 1.03, 1.22, 1.26, 1.35, 1.28, 1.31, 1.1 , 1.76, 1.57, 1.67,
        1.73, 1.73, 1.82, 1.84, 1.79, 1.  , 0.95, 0.96, 1.11],
       [1.04, 1.08, 0.  , 0.61, 0.7 , 1.61, 0.76, 0.98, 1.71, 1.31, 2.02,
        1.72, 2.61, 2.55, 2.72, 2.76, 2.83, 1.79, 1.68, 1.95, 1.97, 2.04,
        2.22, 1.19, 1.26, 1.4 , 1.37, 0.88, 0.64, 1.01, 1.3 , 0.32, 0.42,
        0.19, 0.34, 0.12, 0.16, 0.25, 0.18, 0.86, 0.05, 1.36, 1.17, 1.27,
        1.33, 1.33, 1.42, 1.44, 1.39, 1.64, 1.58, 1.59, 1.75],
       [1.12, 1.51, 0.9 , 0.  , 0.63, 1.69, 1.26, 1.37, 1.51, 1.71, 2.1 ,
        1.8 , 2.41, 2.35, 2.51, 2.56, 2.63, 1.87, 1.76, 2.03, 2.05, 2.12,
        2.01, 1.27, 1.34, 1.48, 1.45, 1.02, 0.91, 1.15, 1.39, 0.82, 1.  ,
        1.05, 0.94, 0.87, 0.91, 0.94, 0.93, 1.  , 0.89, 1.44, 1.25, 1.35,
        1.41, 1.41, 1.5 , 1.52, 1.47, 2.43, 2.36, 2.38, 2.53],
       [1.4 , 0.95, 0.44, 0.48, 0.  , 1.97, 0.63, 0.85, 1.58, 1.19, 2.38,
        2.08, 2.49, 2.42, 2.59, 2.63, 2.71, 2.15, 2.04, 2.31, 2.33, 2.4 ,
        2.09, 1.55, 1.62, 1.76, 1.73, 0.88, 0.76, 1.01, 1.66, 0.19, 0.37,
        0.42, 0.31, 0.5 , 0.54, 0.63, 0.56, 0.86, 0.39, 1.72, 1.53, 1.63,
        1.69, 1.69, 1.78, 1.8 , 1.75, 1.51, 1.46, 1.47, 1.62],
       [2.34, 1.83, 2.27, 2.05, 1.36, 0.  , 1.95, 1.12, 0.42, 1.72, 0.52,
        0.22, 1.28, 1.21, 1.38, 1.42, 1.5 , 0.29, 1.52, 1.79, 1.81, 1.88,
        0.88, 2.16, 2.24, 2.38, 2.35, 1.75, 1.64, 1.87, 2.28, 2.02, 2.2 ,
        2.26, 2.14, 2.34, 2.38, 1.67, 2.4 , 1.72, 2.22, 2.34, 2.23, 2.25,
        2.31, 2.31, 2.51, 2.42, 2.37, 0.85, 0.78, 0.8 , 0.95],
       [1.31, 0.35, 1.07, 0.84, 0.83, 1.89, 0.  , 0.21, 0.71, 0.56, 2.65,
        2.36, 2.39, 2.32, 2.49, 2.53, 2.61, 2.43, 1.96, 2.23, 2.24, 2.32,
        1.99, 1.46, 1.54, 1.68, 1.65, 1.21, 1.11, 1.34, 1.58, 0.82, 0.99,
        1.05, 0.94, 1.13, 1.17, 1.26, 1.19, 1.19, 1.01, 1.64, 1.45, 1.55,
        1.61, 1.61, 1.7 , 1.72, 1.67, 0.88, 0.83, 0.84, 0.99],
       [1.3 , 0.38, 1.09, 0.86, 0.81, 1.87, 0.5 , 0.  , 0.59, 0.44, 2.64,
        2.34, 2.37, 2.31, 2.47, 2.51, 2.59, 2.41, 1.94, 2.21, 2.23, 2.3 ,
        1.97, 1.45, 1.52, 1.66, 1.63, 1.2 , 1.09, 1.33, 1.57, 0.84, 1.02,
        1.07, 0.96, 1.15, 1.19, 1.28, 1.21, 1.18, 1.03, 1.62, 1.43, 1.53,
        1.59, 1.59, 1.68, 1.7 , 1.65, 0.76, 0.71, 0.72, 0.87],
       [1.43, 0.85, 1.21, 1.33, 0.94, 2.  , 0.97, 0.7 , 0.  , 0.63, 2.77,
        2.47, 2.5 , 2.43, 2.6 , 2.64, 2.72, 2.54, 2.07, 2.34, 2.36, 2.43,
        2.1 , 1.58, 1.65, 1.79, 1.76, 1.33, 1.22, 1.45, 1.7 , 1.13, 1.31,
        1.36, 1.25, 1.18, 1.22, 1.25, 1.24, 1.3 , 1.2 , 1.75, 1.56, 1.66,
        1.72, 1.72, 1.81, 1.83, 1.78, 0.95, 0.9 , 0.91, 1.06],
       [1.86, 1.43, 1.87, 1.65, 1.38, 2.44, 1.56, 1.14, 0.44, 0.  , 2.  ,
        2.91, 2.94, 2.87, 3.04, 3.08, 3.16, 2.98, 2.51, 2.78, 2.79, 2.87,
        2.54, 2.01, 2.09, 2.23, 2.2 , 1.76, 1.66, 1.89, 2.13, 1.62, 1.8 ,
        1.86, 1.75, 1.94, 1.98, 1.69, 2.  , 1.74, 1.82, 2.19, 2.  , 2.1 ,
        2.16, 2.16, 2.25, 2.27, 2.22, 0.6 , 0.55, 0.56, 0.71],
       [2.27, 1.75, 2.19, 1.97, 1.78, 2.45, 1.87, 1.68, 0.84, 0.71, 0.  ,
        2.37, 2.38, 2.32, 2.48, 2.53, 2.6 , 2.44, 2.63, 2.89, 2.91, 2.99,
        1.98, 2.42, 2.49, 2.63, 2.6 , 2.17, 2.63, 2.29, 2.54, 1.94, 2.12,
        2.18, 2.06, 2.26, 2.3 , 2.38, 2.32, 2.14, 2.14, 2.59, 2.4 , 2.5 ,
        2.56, 2.56, 2.65, 2.67, 2.62, 0.33, 0.26, 0.28, 0.43],
       [2.12, 2.64, 3.08, 2.86, 2.17, 1.13, 2.76, 1.93, 1.23, 2.53, 1.33,
        0.  , 1.06, 0.99, 1.16, 1.2 , 1.28, 1.1 , 1.3 , 1.57, 1.59, 1.66,
        0.66, 1.94, 2.02, 2.16, 2.13, 2.22, 2.23, 2.25, 2.06, 2.83, 3.01,
        3.07, 2.95, 3.15, 3.19, 2.48, 3.2 , 2.2 , 3.03, 2.12, 2.01, 2.03,
        2.09, 2.09, 2.29, 2.2 , 2.15, 1.66, 1.59, 1.6 , 1.76],
       [1.35, 2.08, 2.52, 2.29, 1.6 , 0.35, 2.2 , 1.37, 0.66, 1.96, 0.76,
        0.46, 0.  , 1.18, 0.14, 0.18, 0.26, 0.54, 0.53, 0.79, 0.81, 0.89,
        1.12, 1.17, 1.25, 1.38, 1.35, 1.45, 1.46, 1.48, 1.29, 2.27, 2.44,
        2.5 , 2.39, 2.58, 1.73, 1.67, 1.72, 1.43, 2.46, 1.34, 1.23, 1.25,
        1.32, 1.31, 1.52, 1.43, 1.37, 1.09, 1.03, 1.04, 1.19],
       [1.31, 2.04, 2.48, 2.25, 1.56, 0.31, 2.16, 1.33, 0.62, 1.92, 0.72,
        0.42, 0.24, 0.  , 0.34, 0.39, 0.46, 0.5 , 0.49, 0.75, 0.77, 0.85,
        1.08, 1.13, 1.21, 1.34, 1.31, 1.41, 1.42, 1.44, 1.25, 2.23, 2.4 ,
        2.46, 2.35, 2.54, 1.69, 1.63, 1.68, 1.39, 2.42, 1.3 , 1.19, 1.21,
        1.28, 1.27, 1.48, 1.39, 1.33, 1.05, 0.99, 1.  , 1.15],
       [1.45, 2.18, 2.62, 2.39, 1.7 , 0.45, 2.3 , 1.47, 0.77, 2.07, 0.86,
        0.56, 0.14, 1.28, 0.  , 0.04, 0.12, 0.64, 0.63, 0.89, 0.91, 0.99,
        1.22, 1.27, 1.35, 1.49, 1.45, 1.55, 1.56, 1.58, 1.39, 2.37, 2.55,
        2.6 , 2.49, 2.68, 1.84, 1.77, 1.82, 1.53, 2.56, 1.45, 1.34, 1.36,
        1.42, 1.41, 1.62, 1.53, 1.47, 1.19, 1.13, 1.14, 1.29],
       [1.49, 2.22, 2.66, 2.44, 1.75, 0.5 , 2.34, 1.51, 0.81, 2.11, 0.91,
        0.61, 0.18, 1.33, 0.04, 0.  , 0.07, 0.68, 0.67, 0.94, 0.96, 1.03,
        1.27, 1.31, 1.39, 1.53, 1.5 , 1.59, 1.6 , 1.62, 1.43, 2.41, 2.59,
        2.65, 2.53, 2.73, 1.88, 1.81, 1.86, 1.57, 2.61, 1.49, 1.38, 1.4 ,
        1.46, 1.46, 1.66, 1.57, 1.52, 1.24, 1.17, 1.18, 1.34],
       [1.57, 2.3 , 2.74, 2.51, 1.82, 0.57, 2.42, 1.59, 0.88, 2.18, 0.98,
        0.68, 0.26, 1.4 , 0.12, 0.07, 0.  , 0.75, 0.75, 1.01, 1.03, 1.11,
        1.34, 1.39, 1.46, 1.6 , 1.57, 1.67, 1.68, 1.7 , 1.51, 2.49, 2.66,
        2.72, 2.61, 2.8 , 1.95, 1.89, 1.94, 1.64, 2.68, 1.56, 1.45, 1.47,
        1.53, 1.53, 1.74, 1.64, 1.59, 1.31, 1.24, 1.26, 1.41],
       [1.8 , 1.8 , 1.58, 2.01, 1.31, 1.89, 1.92, 1.08, 0.37, 0.73, 0.59,
        1.81, 1.82, 1.76, 1.93, 1.97, 2.04, 0.  , 2.07, 2.33, 2.35, 2.43,
        1.42, 1.95, 2.03, 2.16, 2.13, 1.7 , 1.6 , 1.83, 2.07, 1.5 , 1.68,
        2.22, 1.62, 1.55, 1.59, 1.62, 1.61, 1.68, 1.58, 2.12, 1.93, 2.03,
        2.1 , 2.09, 2.19, 2.21, 2.15, 0.81, 0.74, 0.75, 0.91],
       [1.88, 2.61, 3.05, 2.83, 2.14, 0.89, 2.73, 1.9 , 1.2 , 2.5 , 1.3 ,
        1.  , 0.82, 0.75, 0.92, 0.96, 1.04, 1.07, 0.  , 0.36, 0.38, 0.46,
        1.23, 1.7 , 1.78, 1.92, 1.89, 1.98, 1.99, 2.01, 1.82, 2.8 , 2.98,
        3.04, 2.92, 3.12, 2.27, 2.2 , 2.25, 1.96, 3.  , 1.88, 1.77, 1.79,
        1.85, 1.85, 2.05, 1.96, 1.91, 1.63, 1.56, 1.57, 1.73],
       [2.33, 2.99, 3.43, 3.21, 2.52, 1.33, 3.11, 2.28, 1.58, 2.88, 1.68,
        1.38, 1.26, 1.2 , 1.36, 1.41, 1.48, 1.45, 1.51, 0.  , 1.79, 1.87,
        0.86, 2.15, 2.22, 2.36, 2.33, 2.43, 2.44, 2.46, 2.27, 3.18, 3.36,
        3.42, 3.3 , 3.5 , 3.54, 2.65, 3.56, 2.4 , 3.38, 2.32, 2.21, 2.23,
        2.29, 2.29, 2.5 , 2.4 , 2.35, 2.01, 1.94, 1.96, 2.11],
       [1.5 , 2.23, 2.67, 2.44, 1.75, 0.5 , 2.35, 1.52, 0.81, 2.11, 0.91,
        0.61, 0.43, 0.37, 0.53, 0.58, 0.65, 0.69, 0.68, 0.94, 0.  , 0.08,
        1.27, 1.32, 1.4 , 1.53, 1.5 , 1.6 , 1.61, 1.63, 1.44, 2.42, 2.59,
        2.65, 2.54, 2.73, 1.88, 1.82, 1.87, 1.58, 2.61, 1.49, 1.38, 1.4 ,
        1.47, 1.46, 1.67, 1.58, 1.52, 1.24, 1.18, 1.19, 1.34],
       [1.42, 2.15, 2.59, 2.37, 1.68, 0.43, 2.27, 1.44, 0.74, 2.04, 0.83,
        0.54, 0.36, 0.29, 0.46, 0.5 , 0.57, 0.61, 0.6 , 0.87, 0.88, 0.  ,
        1.19, 1.24, 1.32, 1.46, 1.42, 1.52, 1.53, 1.55, 1.36, 2.34, 2.52,
        2.57, 2.46, 2.65, 1.81, 1.74, 1.79, 1.5 , 2.54, 1.42, 1.31, 1.33,
        1.39, 1.38, 1.59, 1.5 , 1.45, 1.16, 1.1 , 1.11, 1.27],
       [1.46, 2.19, 2.63, 2.41, 1.72, 0.47, 2.31, 1.48, 0.78, 2.08, 0.88,
        0.58, 0.4 , 0.33, 0.5 , 0.54, 0.62, 0.65, 0.64, 0.91, 0.93, 1.  ,
        0.  , 1.29, 1.36, 1.5 , 1.47, 1.56, 1.58, 1.59, 1.4 , 2.38, 2.56,
        2.62, 2.5 , 2.7 , 1.85, 1.78, 1.83, 1.54, 2.58, 1.46, 1.35, 1.37,
        1.43, 1.43, 1.63, 1.54, 1.49, 1.21, 1.14, 1.16, 1.31],
       [1.3 , 3.18, 1.03, 1.7 , 1.79, 1.45, 1.84, 2.05, 1.76, 3.06, 1.86,
        1.56, 2.24, 2.18, 2.35, 2.39, 2.46, 1.64, 1.53, 1.79, 1.81, 1.89,
        2.22, 0.  , 0.1 , 0.24, 0.2 , 0.56, 0.58, 0.33, 0.14, 1.41, 1.51,
        1.28, 1.43, 0.9 , 0.86, 0.79, 0.84, 0.48, 1.02, 0.26, 0.75, 0.11,
        0.19, 0.16, 0.26, 0.22, 0.23, 2.19, 2.13, 2.14, 2.29],
       [1.31, 3.19, 0.93, 1.53, 1.63, 1.46, 1.68, 1.73, 1.77, 3.07, 1.87,
        1.57, 2.25, 2.19, 2.35, 2.4 , 2.47, 1.64, 1.53, 1.8 , 1.82, 1.9 ,
        2.23, 0.18, 0.  , 0.09, 0.11, 0.46, 0.49, 0.23, 0.15, 1.24, 1.29,
        1.06, 1.21, 0.8 , 0.76, 0.69, 0.74, 0.38, 0.93, 0.27, 0.65, 0.12,
        0.2 , 0.17, 0.27, 0.23, 0.23, 2.2 , 2.13, 2.15, 2.3 ],
       [1.47, 3.35, 0.92, 1.53, 1.63, 1.62, 1.68, 1.9 , 1.93, 3.23, 2.03,
        1.73, 2.41, 2.35, 2.52, 2.56, 2.63, 1.81, 1.7 , 1.96, 1.98, 2.06,
        2.39, 0.17, 0.09, 0.  , 0.1 , 0.46, 0.48, 0.22, 0.1 , 1.24, 1.28,
        1.06, 1.2 , 0.79, 0.75, 0.69, 0.73, 0.37, 0.92, 0.36, 0.65, 0.2 ,
        0.29, 0.26, 0.36, 0.32, 0.18, 2.36, 2.3 , 2.31, 2.46],
       [1.23, 1.89, 0.82, 1.42, 1.52, 1.57, 1.57, 1.62, 1.88, 3.18, 1.98,
        1.68, 2.36, 2.29, 2.46, 2.5 , 2.58, 1.75, 1.64, 1.91, 1.92, 2.  ,
        2.26, 0.19, 0.11, 0.1 , 0.  , 0.36, 0.38, 0.13, 0.26, 1.13, 1.19,
        0.96, 1.1 , 0.7 , 0.65, 0.59, 0.64, 0.28, 0.82, 0.38, 0.55, 0.22,
        0.31, 0.28, 0.37, 0.34, 0.34, 2.31, 2.24, 2.25, 2.41],
       [1.16, 1.75, 0.7 , 1.28, 1.38, 1.74, 1.43, 1.65, 1.72, 1.99, 2.15,
        1.85, 2.63, 2.56, 2.73, 2.77, 2.85, 1.92, 1.81, 2.07, 2.09, 2.17,
        2.23, 0.57, 0.46, 0.46, 0.36, 0.  , 0.24, 0.23, 0.56, 0.99, 1.06,
        0.84, 0.98, 0.55, 0.51, 0.45, 0.49, 0.08, 0.7 , 0.81, 0.56, 0.58,
        0.66, 0.64, 0.73, 0.69, 0.65, 2.48, 2.41, 2.42, 2.58],
       [1.11, 1.51, 0.48, 1.04, 1.14, 1.69, 1.19, 1.41, 1.5 , 1.75, 2.1 ,
        1.8 , 2.41, 2.34, 2.51, 2.55, 2.63, 1.87, 1.76, 2.02, 2.04, 2.12,
        2.01, 0.58, 0.66, 0.59, 0.49, 0.24, 0.  , 0.37, 0.7 , 0.75, 0.85,
        0.62, 0.76, 0.33, 0.29, 0.23, 0.28, 0.22, 0.48, 0.83, 0.57, 0.67,
        0.8 , 0.73, 0.82, 0.78, 0.79, 2.43, 2.36, 2.37, 2.53],
       [1.23, 1.88, 0.83, 1.41, 1.51, 1.81, 1.56, 1.78, 1.76, 2.12, 2.21,
        1.92, 2.67, 2.6 , 2.77, 2.81, 2.89, 1.99, 1.88, 2.14, 2.16, 2.24,
        2.27, 0.31, 0.23, 0.22, 0.13, 0.23, 0.37, 0.  , 0.33, 1.12, 1.19,
        0.97, 1.11, 0.68, 0.64, 0.58, 0.62, 0.15, 0.83, 0.5 , 0.55, 0.35,
        0.43, 0.4 , 0.5 , 0.46, 0.41, 2.54, 2.48, 2.49, 2.65],
       [1.38, 3.25, 1.02, 1.6 , 1.7 , 1.53, 1.75, 2.12, 1.84, 3.14, 1.94,
        1.64, 2.32, 2.25, 2.42, 2.46, 2.54, 1.71, 1.6 , 1.87, 1.88, 1.96,
        2.3 , 0.27, 0.18, 0.1 , 0.19, 0.56, 0.58, 0.33, 0.  , 1.32, 1.42,
        1.19, 1.34, 0.9 , 0.86, 0.79, 0.84, 0.48, 1.14, 0.36, 0.74, 0.3 ,
        0.28, 0.36, 0.17, 0.2 , 0.09, 2.27, 2.2 , 2.21, 2.37],
       [1.3 , 0.85, 0.43, 0.38, 0.81, 1.87, 0.53, 0.75, 1.49, 1.09, 2.28,
        1.98, 2.39, 2.33, 2.49, 2.53, 2.61, 2.05, 1.94, 2.21, 2.23, 2.31,
        1.99, 1.45, 1.52, 1.66, 1.63, 1.2 , 0.87, 1.33, 1.57, 0.  , 0.18,
        0.27, 0.12, 0.49, 0.53, 0.62, 0.55, 1.18, 0.37, 1.62, 1.43, 1.53,
        1.59, 1.59, 1.69, 1.7 , 1.65, 1.41, 1.36, 1.37, 1.52],
       [1.58, 1.13, 0.25, 0.66, 0.76, 2.15, 0.81, 1.04, 1.77, 1.37, 2.56,
        2.26, 2.67, 2.61, 2.77, 2.82, 2.89, 2.34, 2.22, 2.49, 2.51, 2.59,
        2.27, 1.73, 1.81, 1.18, 1.15, 0.93, 0.69, 1.06, 1.2 , 0.37, 0.  ,
        0.24, 0.38, 0.32, 0.36, 0.44, 0.37, 0.91, 0.2 , 1.9 , 1.71, 1.81,
        1.88, 1.87, 1.97, 1.99, 1.29, 1.69, 1.64, 1.65, 1.8 ],
       [1.56, 1.12, 0.48, 0.65, 1.08, 2.14, 0.8 , 1.02, 1.75, 1.35, 2.55,
        2.25, 2.65, 2.59, 2.76, 2.8 , 2.87, 2.32, 2.21, 2.47, 2.49, 2.57,
        2.26, 1.71, 1.79, 1.93, 1.2 , 0.97, 0.74, 1.1 , 1.83, 0.6 , 0.23,
        0.  , 0.15, 0.54, 0.58, 0.67, 0.6 , 0.95, 0.43, 1.89, 1.7 , 1.8 ,
        1.86, 1.86, 1.95, 1.97, 1.92, 1.68, 1.62, 1.63, 1.79],
       [1.42, 0.97, 0.33, 0.5 , 0.93, 1.99, 0.65, 0.87, 1.6 , 1.21, 2.4 ,
        2.1 , 2.51, 2.44, 2.61, 2.65, 2.73, 2.17, 2.06, 2.33, 2.35, 2.42,
        2.11, 1.57, 1.64, 1.78, 1.23, 1.01, 0.77, 1.14, 1.68, 0.45, 0.08,
        0.15, 0.  , 0.4 , 0.44, 0.52, 0.46, 0.99, 0.28, 1.74, 1.55, 1.65,
        1.71, 1.71, 1.8 , 1.82, 1.77, 1.53, 1.48, 1.49, 1.64],
       [1.01, 1.14, 0.12, 0.67, 0.77, 1.58, 0.82, 1.04, 1.4 , 1.38, 1.99,
        1.69, 2.3 , 2.24, 2.4 , 2.45, 2.52, 1.76, 1.65, 1.92, 1.94, 2.01,
        1.9 , 1.16, 1.23, 1.37, 1.34, 0.69, 0.57, 0.81, 1.28, 0.38, 0.48,
        0.26, 0.4 , 0.  , 0.04, 0.13, 0.06, 0.66, 0.12, 1.33, 1.14, 1.24,
        1.3 , 1.3 , 1.39, 1.41, 1.36, 1.7 , 1.65, 1.66, 1.81],
       [1.05, 1.2 , 0.16, 0.73, 0.83, 1.62, 0.88, 1.1 , 1.44, 1.44, 2.03,
        1.73, 2.34, 2.28, 2.44, 2.49, 2.56, 1.8 , 1.69, 1.96, 1.98, 2.05,
        1.94, 1.2 , 1.27, 1.41, 1.38, 0.66, 0.42, 0.78, 1.32, 0.44, 0.52,
        0.3 , 0.44, 0.04, 0.  , 0.17, 0.02, 0.63, 0.16, 1.37, 1.18, 1.28,
        1.34, 1.34, 1.43, 1.45, 1.4 , 1.76, 1.71, 1.72, 1.87],
       [1.11, 1.23, 0.23, 0.76, 0.86, 1.69, 0.91, 1.13, 1.5 , 1.47, 2.1 ,
        1.8 , 2.41, 2.34, 2.51, 2.55, 2.63, 1.87, 1.76, 2.02, 2.04, 2.12,
        2.01, 1.26, 1.34, 1.48, 1.45, 0.69, 0.45, 0.81, 1.38, 0.47, 0.57,
        0.34, 0.49, 0.11, 0.07, 0.  , 0.05, 0.66, 0.23, 1.44, 1.25, 1.35,
        1.41, 1.41, 1.5 , 1.52, 1.47, 1.79, 1.74, 1.75, 1.9 ],
       [1.07, 1.18, 0.18, 0.71, 0.81, 1.64, 0.86, 1.08, 1.46, 1.42, 2.05,
        1.75, 2.36, 2.3 , 2.46, 2.51, 2.58, 1.82, 1.71, 1.98, 2.  , 2.07,
        1.96, 1.22, 1.29, 1.43, 1.4 , 0.64, 0.4 , 0.77, 1.33, 0.42, 0.52,
        0.3 , 0.44, 0.06, 0.02, 0.19, 0.  , 0.62, 0.18, 1.39, 1.2 , 1.3 ,
        1.36, 1.36, 1.45, 1.47, 1.42, 1.74, 1.69, 1.7 , 1.85],
       [1.14, 1.73, 0.68, 1.26, 1.36, 1.72, 1.41, 1.63, 1.7 , 1.97, 2.12,
        1.83, 2.61, 2.54, 2.71, 2.75, 2.83, 1.9 , 1.79, 2.05, 2.07, 2.15,
        2.21, 0.46, 0.38, 0.37, 0.28, 0.08, 0.22, 0.15, 0.48, 0.97, 1.04,
        0.82, 0.96, 0.53, 0.49, 0.43, 0.47, 0.  , 0.68, 0.79, 0.54, 0.5 ,
        0.58, 0.55, 0.65, 0.61, 0.56, 2.45, 2.39, 2.4 , 2.56],
       [1.03, 1.02, 0.05, 0.55, 0.65, 1.61, 0.7 , 0.93, 1.66, 1.26, 2.01,
        1.72, 2.56, 2.5 , 2.66, 2.71, 2.78, 1.79, 1.68, 1.94, 1.96, 2.04,
        2.16, 1.18, 1.26, 1.4 , 1.36, 0.83, 0.59, 0.96, 1.3 , 0.26, 0.37,
        0.14, 0.28, 0.12, 0.16, 0.24, 0.18, 0.81, 0.  , 1.36, 1.17, 1.27,
        1.33, 1.32, 1.42, 1.44, 1.39, 1.58, 1.53, 1.54, 1.69],
       [1.14, 3.01, 1.35, 1.85, 2.12, 1.29, 3.13, 1.88, 1.6 , 2.9 , 1.7 ,
        1.4 , 2.08, 2.01, 2.18, 2.22, 2.3 , 1.47, 1.36, 1.63, 1.65, 1.72,
        2.06, 0.56, 0.48, 0.39, 0.49, 0.86, 0.91, 0.62, 0.3 , 1.56, 1.66,
        1.44, 1.58, 1.2 , 1.16, 1.09, 1.14, 0.77, 1.38, 0.  , 0.5 , 0.16,
        0.07, 0.17, 0.29, 0.16, 0.31, 2.03, 1.96, 1.98, 2.13],
       [1.03, 2.9 , 1.03, 1.61, 2.01, 1.18, 3.02, 1.77, 1.49, 2.79, 1.59,
        1.29, 1.97, 1.9 , 2.07, 2.11, 2.19, 1.36, 1.25, 1.52, 1.54, 1.61,
        1.95, 0.15, 0.23, 0.36, 0.33, 0.56, 0.57, 0.46, 0.27, 1.32, 1.4 ,
        1.17, 1.32, 0.89, 0.84, 0.78, 0.83, 0.61, 1.03, 0.41, 0.  , 0.23,
        0.38, 0.29, 0.39, 0.49, 0.35, 1.92, 1.85, 1.87, 2.02],
       [1.2 , 3.07, 1.19, 1.69, 1.79, 1.35, 1.84, 1.94, 1.66, 2.96, 1.75,
        1.46, 2.14, 2.07, 2.24, 2.28, 2.35, 1.53, 1.42, 1.68, 1.7 , 1.78,
        2.11, 0.41, 0.33, 0.24, 0.33, 0.7 , 0.76, 0.47, 0.14, 1.41, 1.51,
        1.28, 1.43, 1.04, 1.  , 0.94, 0.98, 0.62, 1.23, 0.16, 0.56, 0.  ,
        0.08, 0.06, 0.25, 0.11, 0.22, 2.08, 2.02, 2.03, 2.19],
       [1.11, 2.98, 1.28, 1.78, 2.09, 1.26, 3.11, 1.85, 1.57, 2.87, 1.67,
        1.37, 2.05, 1.99, 2.15, 2.2 , 2.27, 1.44, 1.33, 1.6 , 1.62, 1.69,
        2.03, 0.49, 0.41, 0.32, 0.42, 0.78, 0.84, 0.55, 0.23, 1.49, 1.59,
        1.36, 1.51, 1.13, 1.09, 1.02, 1.07, 0.7 , 1.31, 0.07, 0.47, 0.08,
        0.  , 0.09, 0.22, 0.09, 0.24, 2.  , 1.93, 1.95, 2.1 ],
       [1.21, 3.08, 1.25, 1.75, 2.18, 1.36, 1.9 , 1.95, 1.67, 2.97, 1.76,
        1.47, 2.15, 2.08, 2.25, 2.29, 2.36, 1.54, 1.43, 1.69, 1.71, 1.79,
        2.12, 0.46, 0.38, 0.29, 0.39, 0.76, 0.81, 0.52, 0.2 , 1.46, 1.56,
        1.34, 1.48, 1.1 , 1.06, 0.99, 1.04, 0.67, 1.29, 0.17, 0.57, 0.06,
        0.09, 0.  , 0.26, 0.12, 0.28, 2.09, 2.03, 2.04, 2.2 ],
       [1.31, 3.19, 1.12, 1.63, 1.73, 1.46, 1.78, 2.06, 1.77, 3.07, 1.87,
        1.57, 2.25, 2.19, 2.35, 2.4 , 2.47, 1.64, 1.53, 1.8 , 1.82, 1.9 ,
        2.23, 0.44, 0.35, 0.26, 0.36, 0.73, 0.69, 0.5 , 0.17, 1.34, 1.44,
        1.21, 1.36, 0.98, 0.94, 0.87, 0.92, 0.65, 1.16, 0.29, 0.68, 0.25,
        0.22, 0.26, 0.  , 0.13, 0.08, 2.2 , 2.13, 2.15, 2.3 ],
       [1.22, 3.09, 1.25, 1.75, 2.2 , 1.37, 3.22, 1.96, 1.68, 2.98, 1.78,
        1.48, 2.16, 2.1 , 2.26, 2.31, 2.38, 1.55, 1.44, 1.71, 1.73, 1.8 ,
        2.14, 0.46, 0.38, 0.29, 0.39, 0.76, 0.81, 0.52, 0.2 , 1.46, 1.56,
        1.34, 1.48, 1.1 , 1.06, 0.99, 1.04, 0.67, 1.29, 0.16, 0.58, 0.11,
        0.09, 0.12, 0.13, 0.  , 0.16, 2.11, 2.04, 2.06, 2.21],
       [1.34, 3.21, 1.09, 1.59, 1.69, 1.49, 1.74, 2.08, 1.8 , 3.1 , 1.9 ,
        1.6 , 2.28, 2.21, 2.38, 2.42, 2.5 , 1.67, 1.56, 1.82, 1.84, 1.92,
        2.26, 0.35, 0.27, 0.18, 0.28, 0.65, 0.66, 0.41, 0.09, 1.31, 1.41,
        1.18, 1.33, 0.94, 0.9 , 0.84, 0.88, 0.56, 1.13, 0.31, 0.7 , 0.27,
        0.24, 0.28, 0.08, 0.16, 0.  , 2.23, 2.16, 2.17, 2.33],
       [1.94, 1.42, 1.86, 1.64, 1.45, 2.51, 1.54, 1.35, 0.51, 0.38, 2.07,
        2.98, 3.01, 2.94, 3.11, 3.15, 3.23, 3.05, 2.58, 2.85, 2.87, 2.94,
        2.61, 2.09, 2.16, 2.3 , 2.27, 1.84, 2.3 , 1.96, 2.21, 1.61, 1.79,
        1.85, 1.73, 1.93, 1.97, 2.05, 1.99, 1.81, 1.81, 2.26, 2.07, 2.17,
        2.23, 2.23, 2.32, 2.34, 2.29, 0.  , 0.62, 0.63, 0.79],
       [2.11, 1.59, 2.03, 1.81, 1.62, 2.22, 1.71, 1.52, 0.68, 0.55, 1.47,
        2.13, 2.15, 2.08, 2.25, 2.29, 2.36, 2.21, 2.39, 2.66, 2.67, 2.75,
        1.75, 2.26, 2.33, 2.47, 2.44, 2.01, 2.47, 2.13, 2.38, 1.78, 1.96,
        2.02, 1.9 , 2.1 , 2.14, 2.22, 2.16, 1.98, 1.98, 2.43, 2.24, 2.34,
        2.4 , 2.4 , 2.49, 2.51, 2.46, 0.17, 0.  , 0.07, 0.23],
       [2.33, 1.81, 2.25, 2.03, 1.84, 2.36, 1.93, 1.74, 0.9 , 0.77, 1.62,
        2.28, 2.29, 2.22, 2.39, 2.43, 2.51, 2.35, 2.53, 2.8 , 2.82, 2.89,
        1.89, 2.48, 2.55, 2.69, 2.66, 2.23, 2.69, 2.35, 2.6 , 2.  , 2.18,
        2.24, 2.12, 2.32, 2.36, 2.44, 2.38, 2.2 , 2.2 , 2.65, 2.46, 2.56,
        2.62, 2.62, 2.71, 2.73, 2.68, 0.39, 0.07, 0.  , 0.15],
       [3.04, 2.53, 2.97, 2.74, 2.55, 2.68, 2.65, 2.45, 1.61, 1.49, 1.93,
        2.6 , 2.61, 2.54, 2.71, 2.75, 2.83, 2.67, 2.85, 3.12, 3.14, 3.21,
        2.21, 3.19, 3.27, 3.41, 3.37, 2.94, 3.4 , 3.07, 3.31, 2.72, 2.89,
        2.95, 2.84, 3.03, 3.07, 3.16, 3.09, 2.92, 2.91, 3.36, 3.18, 3.28,
        3.34, 3.33, 3.43, 3.45, 3.39, 1.1 , 1.07, 1.08, 0.  ]])

    solver = FacilityOrderSolver(matrix, home_index, num_vehicles)
    
    return solver.solve(indices_to_visit)


# won't execute unless this file is directly run
# (importing this file wont trigger)
if __name__ == "__main__":
    from pprint import pprint
    from random import sample
    from time import time
    
    print("Visiting default test locations :")
    _start = time()
    pprint(test())
    _elapsed = time() - _start
    print(f"= {_elapsed:5.3f} seconds\n")

    rand_cities = sample(range(20), random.randint(3,8))
    print("Visiting random cities", rand_cities, ":")
    _start = time()
    pprint(test(rand_cities))
    _elapsed = time() - _start
    print(f"= {_elapsed:5.3f} seconds\n")
